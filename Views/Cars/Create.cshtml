@model OC_P5.ViewModels.CarViewModel
@Html.ValidationSummary(true)

@{
    ViewData["Title"] = "Ajouter une voiture";
}

<div class="container form-container">
    <h1 class="text-center my-5">Ajouter une voiture</h1>
    <p class="text-center text-muted">tous les champs sont obligatoires</p>

    <div class="row justify-content-center">
        <div class="col-md-6">
            <form asp-action="Create" method="post" enctype="multipart/form-data">
                <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                <div class="form-group mb-3">
                    <label asp-for="Label" class="form-label">Nom de la voiture</label>
                    <input asp-for="Label" class="form-control" />
                    <span asp-validation-for="Label" class="text-danger"></span>
                </div>

                <div class="form-group mb-3">
                    <label asp-for="VIN" class="form-label">Numéro VIN</label>
                    <input asp-for="VIN" class="form-control" />
                    <span asp-validation-for="VIN" class="text-danger"></span>
                </div>

                <div class="form-group mb-3">
                    <label asp-for="Description" class="form-label">Description</label>
                    <textarea asp-for="Description" class="form-control"></textarea>
                    <span asp-validation-for="Description" class="text-danger"></span>
                </div>

                <div class="form-group mb-3">
                    <label asp-for="YearOfProductionId" class="form-label">Année de production de la voiture</label>
                    <select asp-for="YearOfProductionId" class="form-select" asp-items="Model.YearsOfProduction"></select>
                </div>

                <div class="form-group mb-3">
                    <label asp-for="CarBrandId" class="form-label">Marque de la voiture</label>
                    <select asp-for="CarBrandId" class="form-select" asp-items="Model.CarBrands" id="CarBrandId"></select>
                </div>

                <button type="button" id="addBrandBtn" class="btn btn-primary mb-3">+ Ajouter une nouvelle marque</button>

                <div class="modal fade" id="addBrandModal" tabindex="-1" aria-labelledby="addBrandModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="addBrandModalLabel">Ajouter une nouvelle marque</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="form-group">
                                    <label for="newBrandName">Nom de la nouvelle marque</label>
                                    <input type="text" class="form-control" id="newBrandName" placeholder="Entrez le nom de la marque">
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                                <button type="button" id="saveBrandBtn" class="btn btn-primary">Enregistrer</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group mb-3">
                    <label asp-for="CarModelId" class="form-label">Modèle de la voiture</label>
                    <select asp-for="CarModelId" class="form-select" asp-items="Model.CarModels" id="CarModelId"></select>
                    <span asp-validation-for="CarModelId" class="text-danger"></span>
                </div>

                <button type="button" id="addModelBtn" class="btn btn-primary mb-3">Ajouter un modèle</button>

                <div class="modal fade" id="addModelModal" tabindex="-1" aria-labelledby="addModelModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="addModelModalLabel">Ajouter un nouveau modèle</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="form-group">
                                    <label for="newModelName">Nom du modèle</label>
                                    <input type="text" id="newModelName" class="form-control" placeholder="Nom du modèle" />
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                                <button id="saveModelBtn" type="button" class="btn btn-primary">Enregistrer le modèle</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group mb-3">
                    <label asp-for="CarTrimId" class="form-label">Finition de la voiture</label>
                    <select asp-for="CarTrimId" class="form-select" asp-items="Model.CarTrims"></select>
                </div>

                <div class="form-group mb-3">
                    <label asp-for="PurchaseDate" class="form-label">Date d'achat</label>
                    <input asp-for="PurchaseDate" class="form-control" type="date" />
                    <span asp-validation-for="PurchaseDate" class="text-danger"></span>
                </div>

                <div class="form-group mb-3">
                    <label asp-for="PurchasePrice" class="form-label">Prix d'achat</label>
                    <input asp-for="PurchasePrice" class="form-control" />
                    <span asp-validation-for="PurchasePrice" class="text-danger"></span>
                </div>

                <div class="form-group mb-3">
                    <label for="MediaFiles" class="form-label">Ajoutez des images</label>
                    <input type="file" asp-for="MediaFiles" multiple class="form-control" />
                    <span asp-validation-for="MediaFiles" class="text-danger"></span>
                    <small class="text-muted">Sélectionnez plusieurs fichiers d'images (jpg, png, etc.)</small>
                </div>

                <div class="text-center">
                    <button type="submit" class="btn btn-warning btn-lg">Publier</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            function loadCarModels(brandId) {
                var carModelSelect = $('#CarModelId');
                carModelSelect.empty();

                if (brandId) {
                    $.getJSON('/Cars/GetCarModelsByBrand', { brandId: brandId }, function (data) {
                        if (data.length > 0) {
                            $.each(data, function (index, item) {
                                carModelSelect.append(new Option(item.model, item.id));
                            });
                        } else {
                            carModelSelect.append(new Option('-- Pas de modèle pour cette marque --', ''));
                        }
                    });
                } else {
                    carModelSelect.append(new Option('-- Sélectionnez une marque --', ''));
                }
            }

            var selectedBrandId = $('#CarBrandId').val();
            loadCarModels(selectedBrandId);

            $('#CarBrandId').change(function () {
                var brandId = $(this).val();
                loadCarModels(brandId);
            });

            $('#addBrandBtn').click(function () {
                $('#addBrandModal').modal('show');
            });

            $('#saveBrandBtn').click(function () {
                var brandName = $('#newBrandName').val().trim();

                if (brandName) {
                    $.ajax({
                        url: '/Cars/AddBrand',
                        method: 'POST',
                        data: { brandName: brandName },
                        success: function (response) {
                            if (response.success) {
                                var newBrandOption = new Option(response.brand.Brand, response.brand.Id, false, true);
                                $('#CarBrandId').append(newBrandOption);

                                $('#CarBrandId').val(response.brand.Id).trigger('change');

                                $('#addBrandModal').modal('hide');
                                $('#newBrandName').val('');
                            } else {
                                alert(response.message || 'Erreur lors de l’ajout de la marque.');
                            }
                        },
                        error: function () {
                            alert('Erreur lors de l’enregistrement de la marque.');
                        }
                    });
                } else {
                    alert('Veuillez entrer un nom de marque valide.');
                }
            });

            $('#addModelBtn').click(function () {
                $('#addModelModal').modal('show');
            });

            $('#saveModelBtn').click(function () {
                var modelName = $('#newModelName').val().trim();
                var brandId = $('#CarBrandId').val();

                if (modelName && brandId) {
                    $.ajax({
                        url: '/Cars/AddModel',
                        method: 'POST',
                        data: { modelName: modelName, brandId: brandId },
                        success: function (response) {
                            if (response.success) {
                                var newModelOption = new Option(response.model.Model, response.model.Id, false, true);
                                $('#CarModelId').append(newModelOption);

                                $('#CarModelId').val(response.model.Id);

                                $('#addModelModal').modal('hide');
                                $('#newModelName').val('');
                            } else {
                                alert(response.message || 'Erreur lors de l’ajout du modèle.');
                            }
                        },
                        error: function () {
                            alert('Erreur lors de l’enregistrement du modèle.');
                        }
                    });
                } else {
                    alert('Veuillez entrer un nom de modèle valide et sélectionner une marque.');
                }
            });

            $('#addBrandModal').on('hidden.bs.modal', function () {
                $('#newBrandName').val('');
            });

            $('#addModelModal').on('hidden.bs.modal', function () {
                $('#newModelName').val('');
            });
        });
    </script>
}
